{% extends 'base.html' %}
{% block title %} Identify Activity{% endblock %}
{% block content %}
<div class="d-flex bg-primary py-2 text-white justify-content-center">Activity Identification on Yuktdhara</div>

<!-- Applied Filters Row -->
<div class="d-flex justify-content-between fs-8 align-items-center py-2 px-3 bg-light border-bottom" id="applied-filters-row">
    <div class="d-flex flex-wrap gap-1 align-items-center">
        <span class="text-muted me-2">Applied Filters:</span>
        <div id="applied-filters-container" class="d-flex flex-wrap gap-1">
            <!-- Filter badges will be inserted here -->
        </div>
        <span id="no-filters-text" class="text-muted fst-italic">None</span>
    </div>
    <button type="button" class="btn btn-outline-danger btn-sm fs-8" id="clear-all-filters">
        <i class="fas fa-times"></i> Clear All
    </button>
</div>

<!-- FIRST ROW - Original btn-group styling -->
<div class="d-flex justify-content-between">
    <div class="card flex-fill m-2 pb-3">
        <div class="card-body px-2">
            <div class="d-grid gap-2">
                <div class="fw-bold text-center">Nature of Work</div>
                <div class="btn-group" role="group" aria-label="Nature of Work selection">
                    {% for item in nature_of_work %}
                    <input type="radio" class="btn-check" name="nature_of_works" id="btn{{item.short_name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="nature_of_works" data-label="{{item.short_name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.short_name}}{{loop.index}}">{{ item.short_name}}</label>
                    {% endfor %}
                </div>
                <div class="fw-bold text-center">Master Category</div>
                <div class="btn-group" role="group" aria-label="Master Category selection" id="categories-container">
                    {% for item in categories %}
                    <input type="radio" class="btn-check" name="categories" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="categories" data-label="{{item.name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name}}</label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="card flex-fill m-2">
        <div class="card-body px-2">
            <div class="d-grid gap-2">
                <div class="fw-bold text-center">Select Ridge</div>
                <div class="btn-group" role="group" aria-label="Ridge selection">
                    {% for item in ridges %}
                    <input type="radio" class="btn-check" name="ridges" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="ridges" data-label="{{item.name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name }}</label>
                    {% endfor %}
                </div>
                <div class="fw-bold text-center">Select Cluster</div>
                <div class="btn-group" role="group" aria-label="Cluster selection">
                    {% for item in clusters %}
                    <input type="radio" class="btn-check" name="clusters" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="clusters" data-label="{{item.name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name }}</label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>    
    <div class="card flex-fill m-2">
        <div class="card-body px-2">
            <div class="d-grid gap-2">
                <div class="fw-bold text-center">Slope %</div>
                <div class="btn-group" role="group" aria-label="Slope selection">
                    {% for item in slopes %}
                    <input type="radio" class="btn-check" name="slopes" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="slopes" data-label="{{item.name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name }}</label>
                    {% endfor %}
                </div>
                <div class="fw-bold text-center">Water Works</div>
                <div class="btn-group" role="group" aria-label="Water Works selection">
                    {% for item in water_works %}
                    <input type="radio" class="btn-check" name="water_works" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="water_works" data-label="{{item.name}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name}}</label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="card flex-fill m-2">
        <div class="card-body px-2">
            <div class="d-grid gap-2">
                <div class="fw-bold text-center">Beneficiary Type</div>
                <div class="btn-group" role="group" aria-label="Beneficiary Type selection" id="beneficiaries-container">
                    {% for item in beneficiaries %}
                    <input type="radio" class="btn-check" name="beneficiaries" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="beneficiaries" data-label="{{item.name | capitalize}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.name}}{{loop.index}}">{{ item.name | capitalize}}</label>
                    {% endfor %}
                </div>
                <div class="fw-bold text-center">Activity Type</div>
                <div class="btn-group" role="group" aria-label="Activity Type selection" id="activities-container">
                    {% for item in activities %}
                    <input type="radio" class="btn-check" name="activity_types" id="btn{{item.short_name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="activity_types" data-label="{{item.short_name | capitalize}}">
                    <label class="btn btn-outline-dark btn-sm text-center" for="btn{{item.short_name}}{{loop.index}}">{{ item.short_name | capitalize}}</label>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SECOND ROW - Radio row styling with search -->
<div class="d-flex justify-content-between align-items-stretch" id="second-row"> 
    <div class="card flex-fill mx-2 d-flex flex-column scrollable-card">
        <div class="card-header text-center">
            <div class="d-flex justify-content-between align-items-center">
                <span>{{ "Land Type" }}</span>
                <span class="perfect-circle bg-dark text-white fs-7 p-1" id="land-types-count">{{land_types|length}}</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- Search input -->
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm search-input" id="land-types-search" placeholder="Search land types..." autocomplete="off">
            </div>
            <div class="overflow-auto flex-fill scrollable-body">
                <div class="d-grid gap-2" id="land-types-container">
                {% for item in land_types %}
                <div class="radio-row">
                    <input type="radio" class="btn-check" name="location_specifics" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="location_specifics" data-label="{{item.name | capitalize}}">
                    <label class="btn btn-outline-dark btn-sm full-width-label" for="btn{{item.name}}{{loop.index}}">{{ item.name | capitalize}}</label>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>   
    <div class="card flex-fill mx-2 d-flex flex-column scrollable-card">
        <div class="card-header text-center">
            <div class="d-flex justify-content-between align-items-center">
                <span>{{ "Major Scheduled Category" }}</span>
                <span class="perfect-circle bg-dark text-white fs-7 p-1" id="major-scheduled-count">{{major_scheduled_category|length}}</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- Search input -->
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm search-input" id="major-scheduled-search" placeholder="Search categories..." autocomplete="off">
            </div>
            <div class="overflow-auto flex-fill scrollable-body">
                <div class="d-grid gap-2" id="major-scheduled-container">
                {% for item in major_scheduled_category %}
                <div class="radio-row">
                    <input type="radio" class="btn-check" name="major_scheduled_category" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="major_scheduled_category" data-label="{{item.name | capitalize}}">
                    <label class="btn btn-outline-dark btn-sm full-width-label" for="btn{{item.name}}{{loop.index}}">{{ item.name | capitalize}}</label>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="card flex-fill mx-2 d-flex flex-column scrollable-card">
        <div class="card-header text-center">
            <div class="d-flex justify-content-between align-items-center">
                <span>{{ "Work Type" }}</span>
                <span class="perfect-circle bg-dark text-white fs-7 p-1" id="work-types-count">{{work_types|length}}</span>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- Search input -->
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm search-input" id="work-types-search" placeholder="Search work types..." autocomplete="off">
            </div>
            <div class="overflow-auto flex-fill scrollable-body">
                <div class="d-grid gap-2" id="work-types-container">
                {% for item in work_types %}
                <div class="radio-row">
                    <input type="radio" class="btn-check" name="work_types" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="work_types" data-label="{{item.name | capitalize}}">
                    <label class="btn btn-outline-dark btn-sm full-width-label" for="btn{{item.name}}{{loop.index}}">{{ item.name | capitalize}}</label>
                </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="card flex-fill mx-2 d-flex flex-column scrollable-card">
        <div class="card-header text-center">
            <div class="d-flex justify-content-between align-items-center">
                <div>{{ "Permissible Work"}}</div>
                <div class="perfect-circle bg-dark text-white fs-7 p-1" id="permissible-works-count">{{permissible_works|length}}</div>
            </div>
        </div>
        <div class="card-body d-flex flex-column">
            <!-- Search input -->
            <div class="mb-2">
                <input type="text" class="form-control form-control-sm search-input" id="permissible-works-search" placeholder="Search permissible works..." autocomplete="off">
            </div>
            <div class="overflow-auto flex-fill scrollable-body">
                <div class="d-grid gap-2" id="permissible-works-container">
                {% for item in permissible_works %}
                    <div class="radio-row">
                        <input type="radio" class="btn-check" name="permissible_works" id="btn{{item.name}}{{loop.index}}" autocomplete="off" value="{{item.id}}" data-id="{{item.id}}" data-group="permissible_works" data-label="{{item.name | capitalize}}">
                        <label class="btn btn-outline-dark btn-sm full-width-label" for="btn{{item.name}}{{loop.index}}">{{ item.name | capitalize}}</label>
                    </div>
                {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="card border border-2 border-primary mx-2 d-flex flex-column yuktdhara-card" id="yuktdhara-card">
        <div class="card-header text-center bg-primary text-white">Yuktdhara Dropdown Selections</div>
        <div class="card-body d-flex flex-column">
            <div class="d-grid gap-2 flex-fill">
                <div class="form-floating">
                    <input type="text" name="gaw" id="gaw" class="form-control scrollable-input" placeholder="GAW/Non-GAW" readonly>
                    <label for="gaw" class="fs-7">GAW/Non-GAW</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="master_catgory" id="master_catgory" class="form-control scrollable-input" placeholder="Master Category" readonly>
                    <label for="master_catgory" class="fs-7">Master Category</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="major_scheduled_category" id="major_scheduled_category" class="form-control scrollable-input" placeholder="Major Scheduled Category" readonly>
                    <label for="major_scheduled_category" class="fs-7">Major Scheduled Category</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="beneficiary_type" id="beneficiary_type" class="form-control scrollable-input" placeholder="Beneficiary Type" readonly>
                    <label for="beneficiary_type" class="fs-7">Beneficiary Type</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="activity_type" id="activity_type" class="form-control scrollable-input" placeholder="Activity Type" readonly>
                    <label for="activity_type" class="fs-7">Activity Type</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="work_type" id="work_type" class="form-control scrollable-input" placeholder="Work Type" readonly>
                    <label for="work_type" class="fs-7">Work Type</label>
                </div>
                <div class="form-floating">
                    <input type="text" name="permissible_work" id="permissible_work" class="form-control scrollable-input" placeholder="Permissible Works" readonly>
                    <label for="permissible_work" class="fs-7">Permissible Works</label>
                </div>
            </div>
        </div>
    </div> 
</div>

<style>
/* Loader overlay */
#loaderOverlay {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(255,255,255,0.75);
    z-index: 2000;
    backdrop-filter: blur(1px);
}
#loaderOverlay.show {
    display: flex;
}
.loader-spinner {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    border: .35rem solid #e9ecef;
    border-top-color: #0d6efd;
    animation: spin .8s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Full width labels for second row cards */
.full-width-label {
    width: 100% !important;
    text-align: center !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    min-height: 38px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
}

/* Radio row styling for second row only */
.radio-row {
    display: flex;
    align-items: stretch;
    min-height: 38px;
}

.radio-row input.btn-check {
    flex-shrink: 0;
    margin-right: 0;
}

.radio-row label {
    flex: 1;
}

/* Scrollable inputs in yuktdhara card */
.scrollable-input {
    overflow-x: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    white-space: nowrap;
}

.scrollable-input::-webkit-scrollbar {
    display: none;
}

/* Disabled radio button styling */
.btn-check:disabled + .btn {
    opacity: 0.4;
    pointer-events: none;
    background-color: #f8f9fa;
    border-color: #dee2e6;
    color: #6c757d;
}

/* Filter badges */
.filter-badge {
    background-color: var(--bs-secondary);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    font-size: 0.7rem;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    cursor: pointer;
    transition: background-color 0.15s ease-in-out;
}

.filter-badge:hover {
    background-color: var(--bs-danger);
}

.filter-badge .remove-filter {
    background: none;
    border: none;
    color: white;
    padding: 0;
    margin-left: 0.25rem;
    cursor: pointer;
    font-size: 0.875rem;
}

/* Text centering for first row labels */
.btn-group .btn {
    text-align: center !important;
}


/* Second row layout improvements */
#second-row {
    min-height: 400px;
}

/* Yuktdhara card improvements */
.yuktdhara-card {
    width: 300px;
    min-width: 300px;
    max-width: 350px;
}

/* Scrollable cards specific styling */
.scrollable-card {
    max-height: 600px;
}

.scrollable-card .scrollable-body {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    scrollbar-width: none;
    -ms-overflow-style: none;
}

.scrollable-card .scrollable-body::-webkit-scrollbar {
    display: none;
}

/* Ensure Yuktdhara card grows with content */
.yuktdhara-card .card-body {
    min-height: 300px;
}

/* Search input styling */
.search-input {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.search-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Hidden items for search */
.search-hidden {
    display: none !important;
}

/* Responsive adjustments */
@media (max-width: 1200px) {
    .yuktdhara-card {
        width: 280px;
        min-width: 280px;
    }
}

@media (max-width: 992px) {
    #second-row {
        flex-wrap: wrap;
    }
    
    .yuktdhara-card {
        width: 100%;
        max-width: none;
        order: -1;
    }
}
</style>

<!-- Loader markup -->
<div id="loaderOverlay" role="status" aria-live="polite" aria-label="Loading">
    <div class="loader-spinner" aria-hidden="true"></div>
    <div class="ms-3 fw-semibold text-primary">Filtering…</div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const FILTER_ENDPOINT = '/dashboard/activity_identification/filter';
    let allSelections = new Set(); // Track all selections (manual + auto)

    // Map filter groups to display fields
    const GROUP_TO_DISPLAY_FIELD = {
        nature_of_works: 'gaw',
        categories: 'master_catgory',
        major_scheduled_category: 'major_scheduled_category',
        beneficiaries: 'beneficiary_type',
        activity_types: 'activity_type',
        work_types: 'work_type',
        permissible_works: 'permissible_work'
    };

    // Map groups to containers
    const GROUP_TO_CONTAINER = {
        categories: 'categories-container',
        major_scheduled_category: 'major-scheduled-container',
        beneficiaries: 'beneficiaries-container',
        activity_types: 'activities-container',
        work_types: 'work-types-container',
        permissible_works: 'permissible-works-container',
        location_specifics: 'land-types-container'
    };

    // Map groups to count elements
    const GROUP_TO_COUNT = {
        major_scheduled_category: 'major-scheduled-count',
        work_types: 'work-types-count',
        permissible_works: 'permissible-works-count',
        location_specifics: 'land-types-count'
    };

    // Initialize display fields
    Object.values(GROUP_TO_DISPLAY_FIELD).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '?';
    });

    // Loader management
    const overlay = document.getElementById('loaderOverlay');
    let inflight = 0;

    function showLoader() {
        inflight++;
        if (inflight === 1) {
            overlay.classList.add('show');
            document.body.setAttribute('aria-busy', 'true');
        }
    }
    
    function hideLoader() {
        inflight = Math.max(0, inflight - 1);
        if (inflight === 0) {
            overlay.classList.remove('show');
            document.body.removeAttribute('aria-busy');
        }
    }

    // Frontend-only search functionality
    function setupSearch() {
        const searchInputs = document.querySelectorAll('.search-input');
        
        searchInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                const searchTerm = e.target.value.trim().toLowerCase();
                const containerId = e.target.id.replace('-search', '-container');
                const container = document.getElementById(containerId);
                
                if (!container) return;
                
                const radioRows = container.querySelectorAll('.radio-row');
                
                radioRows.forEach(row => {
                    const label = row.querySelector('label');
                    if (label) {
                        const labelText = label.textContent.toLowerCase();
                        if (searchTerm === '' || labelText.includes(searchTerm)) {
                            row.classList.remove('search-hidden');
                        } else {
                            row.classList.add('search-hidden');
                        }
                    }
                });
            });
        });
    }

    // Helper functions
    const getLabelText = (input) => input.getAttribute('data-label') || '';

    // Applied filters management
    const appliedFiltersContainer = document.getElementById('applied-filters-container');
    const noFiltersText = document.getElementById('no-filters-text');
    const clearAllBtn = document.getElementById('clear-all-filters');

    function updateAppliedFilters(selections) {
        appliedFiltersContainer.innerHTML = '';
        let hasFilters = false;

        // Show ALL selections, not just manual ones
        Object.entries(selections).forEach(([group, data]) => {
            if (data.ids.length > 0) {
                hasFilters = true;
                data.labels.forEach((label, index) => {
                    const badge = document.createElement('span');
                    badge.className = 'filter-badge';
                    badge.innerHTML = `
                        ${label}
                        <button type="button" class="remove-filter" data-group="${group}" data-id="${data.ids[index]}" aria-label="Remove ${label} filter">
                            ×
                        </button>
                    `;
                    appliedFiltersContainer.appendChild(badge);
                });
            }
        });

        noFiltersText.style.display = hasFilters ? 'none' : 'inline';
    }

    // Handle filter removal
    appliedFiltersContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-filter')) {
            const group = e.target.getAttribute('data-group');
            const id = e.target.getAttribute('data-id');
            
            const radioBtn = document.querySelector(`input[data-group="${group}"][data-id="${id}"]`);
            if (radioBtn) {
                radioBtn.checked = false;
                allSelections.delete(`${group}_${id}`);
                onChange();
            }
        }
    });

    // Clear all filters
    clearAllBtn.addEventListener('click', () => {
        document.querySelectorAll('input.btn-check[data-group]').forEach(input => {
            input.checked = false;
        });
        allSelections.clear();
        onChange();
    });

    // Collect selections
    const collectSelections = () => {
        const result = {};
        const radios = document.querySelectorAll('input.btn-check[data-group]');
        
        radios.forEach(input => {
            const group = input.getAttribute('data-group');
            if (!result[group]) {
                result[group] = { ids: [], labels: [] };
            }
        });
        
        radios.forEach(input => {
            const group = input.getAttribute('data-group');
            if (input.checked) {
                result[group].ids = [parseInt(input.getAttribute('data-id'))];
                result[group].labels = [getLabelText(input)];
            }
        });
        
        return result;
    };

    // Update display fields
    const updateDisplayFields = (selections, autoFillData = {}) => {
        Object.entries(GROUP_TO_DISPLAY_FIELD).forEach(([group, fieldId]) => {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            let value = '?';
            const labels = (selections[group]?.labels || []);
            
            if (labels.length > 0) {
                value = labels[0];
            } else if (autoFillData[group]) {
                value = autoFillData[group].name;
            }
            
            field.value = value;
        });
    };

    // Update radio button groups for first row (btn-group)
    const updateBtnGroup = (group, items, labelField) => {
        const container = document.getElementById(GROUP_TO_CONTAINER[group]);
        if (!container) return;

        let currentSelection = null;
        const existingInput = container.querySelector('input.btn-check:checked');
        if (existingInput) {
            currentSelection = parseInt(existingInput.getAttribute('data-id'));
        }

        container.innerHTML = '';

        items.forEach((item, index) => {
            const inputId = `btn${item[labelField]}${index}_${Date.now()}`;
            const isChecked = currentSelection === item.id;
            const isDisabled = item.disabled || false;
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.className = 'btn-check';
            input.name = group;
            input.id = inputId;
            input.autocomplete = 'off';
            input.value = item.id;
            input.setAttribute('data-id', item.id);
            input.setAttribute('data-group', group);
            input.setAttribute('data-label', item[labelField].charAt(0).toUpperCase() + item[labelField].slice(1));
            input.checked = isChecked && !isDisabled;
            input.disabled = isDisabled;

            const label = document.createElement('label');
            label.className = 'btn btn-outline-dark btn-sm text-center';
            label.setAttribute('for', inputId);
            label.textContent = item[labelField].charAt(0).toUpperCase() + item[labelField].slice(1);

            container.appendChild(input);
            container.appendChild(label);
        });
    };

    // Update radio button groups for second row (radio-row)
    const updateRadioGroup = (group, items, labelField) => {
        const container = document.getElementById(GROUP_TO_CONTAINER[group]);
        if (!container) return;

        let currentSelection = null;
        const existingInput = container.querySelector('input.btn-check:checked');
        if (existingInput) {
            currentSelection = parseInt(existingInput.getAttribute('data-id'));
        }

        container.innerHTML = '';

        items.forEach((item, index) => {
            const inputId = `btn${item[labelField]}${index}_${Date.now()}`;
            const isChecked = currentSelection === item.id;
            const isDisabled = item.disabled || false;
            
            const radioRow = document.createElement('div');
            radioRow.className = 'radio-row';
            
            const input = document.createElement('input');
            input.type = 'radio';
            input.className = 'btn-check';
            input.name = group;
            input.id = inputId;
            input.autocomplete = 'off';
            input.value = item.id;
            input.setAttribute('data-id', item.id);
            input.setAttribute('data-group', group);
            input.setAttribute('data-label', item[labelField].charAt(0).toUpperCase() + item[labelField].slice(1));
            input.checked = isChecked && !isDisabled;
            input.disabled = isDisabled;

            const label = document.createElement('label');
            label.className = 'btn btn-outline-dark btn-sm full-width-label';
            label.setAttribute('for', inputId);
            label.textContent = item[labelField].charAt(0).toUpperCase() + item[labelField].slice(1);

            radioRow.appendChild(input);
            radioRow.appendChild(label);
            container.appendChild(radioRow);
        });
    };

    // Update counts
    const updateCount = (countId, count) => {
        const countEl = document.getElementById(countId);
        if (countEl) {
            countEl.textContent = count || 0;
        }
    };

    // Update dynamic elements
    const updateDynamicElements = (data) => {
        // First row updates (btn-group style)
        if (data.categories) {
            updateBtnGroup('categories', data.categories, 'name');
        }
        
        if (data.beneficiaries) {
            updateBtnGroup('beneficiaries', data.beneficiaries, 'name');
        }
        
        if (data.activity_types) {
            updateBtnGroup('activity_types', data.activity_types, 'short_name');
        }

        // Second row updates (radio-row style)
        if (data.major_scheduled_category) {
            updateRadioGroup('major_scheduled_category', data.major_scheduled_category, 'name');
            updateCount('major-scheduled-count', data.major_scheduled_category_count);
        }
        
        if (data.work_types) {
            updateRadioGroup('work_types', data.work_types, 'name');
            updateCount('work-types-count', data.work_types_count);
        }
        
        if (data.permissible_works) {
            updateRadioGroup('permissible_works', data.permissible_works, 'name');
            updateCount('permissible-works-count', data.permissible_works_count);
        }

        if (data.location_specifics) {
            updateRadioGroup('location_specifics', data.location_specifics, 'name');
            updateCount('land-types-count', data.location_specifics_count);
        }
    };

    // Handle auto-fill
    const handleAutoFill = (autoFillData) => {
        Object.entries(autoFillData).forEach(([group, data]) => {
            const currentRadio = document.querySelector(`input[data-group="${group}"]:checked`);
            if (!currentRadio) {
                const radioToSelect = document.querySelector(`input[data-group="${group}"][data-id="${data.id}"]`);
                if (radioToSelect && !radioToSelect.disabled) {
                    radioToSelect.checked = true;
                    allSelections.add(`${group}_${data.id}`);
                }
            }
        });
    };

    // Debounced filtering
    let debounceTimer = null;
    let currentAbort = null;

    const debouncedFilter = (selections) => {
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            try {
                const filterData = {};
                
                Object.keys(selections).forEach(group => {
                    const ids = selections[group].ids;
                    if (ids && ids.length > 0) {
                        filterData[group] = ids;
                    }
                });

                if (currentAbort) currentAbort.abort();
                currentAbort = new AbortController();

                showLoader();

                const response = await fetch(FILTER_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest',
                    },
                    credentials: 'same-origin',
                    signal: currentAbort.signal,
                    body: JSON.stringify(filterData)
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        updateDynamicElements(result.data);
                        
                        const autoFill = result.data.auto_fill;
                        if (autoFill && Object.keys(autoFill).length > 0) {
                            setTimeout(() => {
                                handleAutoFill(autoFill);
                                const updatedSelections = collectSelections();
                                updateDisplayFields(updatedSelections, autoFill);
                                updateAppliedFilters(updatedSelections);
                            }, 100);
                        }
                        
                        // Re-setup search after dynamic updates
                        setupSearch();
                    } else {
                        console.error('Filter error:', result.error);
                    }
                } else {
                    console.error('HTTP error:', response.status);
                }

            } catch (error) {
                if (error.name !== 'AbortError') {
                    console.error('Fetch error:', error);
                }
            } finally {
                hideLoader();
            }
        }, 300);
    };

    // Handle changes
    const onChange = () => {
        const selections = collectSelections();
        updateDisplayFields(selections);
        updateAppliedFilters(selections);
        debouncedFilter(selections);
    };

    // Track selections
    document.addEventListener('pointerdown', (evt) => {
        let input = null;
        if (evt.target.matches('input.btn-check[data-group]')) {
            input = evt.target;
        } else if (evt.target.matches('label[for]')) {
            const forId = evt.target.getAttribute('for');
            const el = document.getElementById(forId);
            if (el && el.matches('input.btn-check[data-group]')) input = el;
        }
        
        if (input && input.type === 'radio' && input.checked && !input.disabled) {
            input.dataset.wasChecked = 'true';
        }
    });

    document.addEventListener('click', (evt) => {
        let input = null;
        if (evt.target.matches('input.btn-check[data-group]')) {
            input = evt.target;
        } else if (evt.target.matches('label[for]')) {
            const forId = evt.target.getAttribute('for');
            const el = document.getElementById(forId);
            if (el && el.matches('input.btn-check[data-group]')) input = el;
        }
        
        if (input) {
            if (input.dataset.wasChecked === 'true') {
                input.checked = false;
                delete input.dataset.wasChecked;
                const key = `${input.getAttribute('data-group')}_${input.getAttribute('data-id')}`;
                allSelections.delete(key);
                input.dispatchEvent(new Event('change', { bubbles: true }));
                evt.preventDefault();
            } else {
                delete input.dataset.wasChecked;
                if (input.checked) {
                    const key = `${input.getAttribute('data-group')}_${input.getAttribute('data-id')}`;
                    allSelections.add(key);
                }
            }
        }
    });

    // Handle radio button changes
    document.addEventListener('change', (evt) => {
        const target = evt.target;
        if (target && target.matches('input.btn-check[data-group]')) {
            if (target.checked) {
                const key = `${target.getAttribute('data-group')}_${target.getAttribute('data-id')}`;
                allSelections.add(key);
            }
            onChange();
        }
    });

    // Initialize search functionality
    setupSearch();

    // Initial sync
    const initialSelections = collectSelections();
    updateDisplayFields(initialSelections);
    updateAppliedFilters(initialSelections);
});
</script>
{% endblock %}